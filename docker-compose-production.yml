

################################################################################
# SCADA CRITICAL INFRASTRUCTURE SIMULATOR - PRODUCTION ARCHITECTURE
# All 22 services with proper networking, health checks, and dependencies
################################################################################

services:

  # ============================================================================
  # INFRASTRUCTURE SERVICES
  # ============================================================================

  timescaledb:
    image: timescale/timescaledb:latest-pg15
    container_name: scada_timescaledb
    environment:
      POSTGRES_PASSWORD: scada123
      POSTGRES_USER: scada
      POSTGRES_DB: scadadb
    ports:
      - "5432:5432"
    volumes:
      - timescaledb_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      occ_net:
        ipv4_address: 10.0.0.100
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U scada -d scadadb"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: scada_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      occ_net:
        ipv4_address: 10.0.0.101
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  prometheus:
    image: prom/prometheus:latest
    container_name: scada_prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    networks:
      occ_net:
        ipv4_address: 10.0.0.102
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5

  grafana:
    image: grafana/grafana:latest
    container_name: scada_grafana
    ports:
      - "3001:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin123
      GF_SECURITY_ADMIN_USER: admin
      GF_INSTALL_PLUGINS: grafana-piechart-panel
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      occ_net:
        ipv4_address: 10.0.0.103
    depends_on:
      prometheus:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  ntp_server:
    image: cturra/ntp:latest
    container_name: scada_ntp
    ports:
      - "123:123/udp"
    networks:
      occ_net:
        ipv4_address: 10.0.0.104

  # ============================================================================
  # GENERATION NODES (GEN-001, GEN-002, GEN-003)
  # ============================================================================

  node_gen001:
    build:
      context: .
      dockerfile: node_service/Dockerfile
    container_name: scada_node_gen001
    environment:
      NODE_ID: GEN-001
      NODE_TYPE: generation
      UNIT_ID: 1
      REST_PORT: 8101
      WS_PORT: 8102
      MODBUS_PORT: 5020
      IEC104_PORT: 2401
      NODE_IP: 10.1.1.1
      DB_URL: postgresql://scada:scada123@timescaledb:5432/scadadb
      REDIS_URL: redis://redis:6379
      OCC_IP: 10.0.0.1
      SCADA_MASTER_URL: http://scada_master:9000
      LOG_LEVEL: info
    ports:
      - "8101:8101"
      - "8102:8102"
      - "5020:5020"
      - "2401:2401"
    networks:
      generation_net:
        ipv4_address: 10.1.1.1
      occ_net:
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8101/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  node_gen002:
    build:
      context: .
      dockerfile: node_service/Dockerfile
    container_name: scada_node_gen002
    environment:
      NODE_ID: GEN-002
      NODE_TYPE: generation
      UNIT_ID: 2
      REST_PORT: 8103
      WS_PORT: 8104
      MODBUS_PORT: 5021
      IEC104_PORT: 2402
      NODE_IP: 10.1.1.2
      DB_URL: postgresql://scada:scada123@timescaledb:5432/scadadb
      REDIS_URL: redis://redis:6379
      OCC_IP: 10.0.0.1
      SCADA_MASTER_URL: http://scada_master:9000
      LOG_LEVEL: info
    ports:
      - "8103:8103"
      - "8104:8104"
      - "5021:5021"
      - "2402:2402"
    networks:
      generation_net:
        ipv4_address: 10.1.1.2
      occ_net:
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8103/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  node_gen003:
    build:
      context: .
      dockerfile: node_service/Dockerfile
    container_name: scada_node_gen003
    environment:
      NODE_ID: GEN-003
      NODE_TYPE: generation
      UNIT_ID: 3
      REST_PORT: 8105
      WS_PORT: 8106
      MODBUS_PORT: 5022
      IEC104_PORT: 2403
      NODE_IP: 10.1.1.3
      DB_URL: postgresql://scada:scada123@timescaledb:5432/scadadb
      REDIS_URL: redis://redis:6379
      OCC_IP: 10.0.0.1
      SCADA_MASTER_URL: http://scada_master:9000
      LOG_LEVEL: info
    ports:
      - "8105:8105"
      - "8106:8106"
      - "5022:5022"
      - "2403:2403"
    networks:
      generation_net:
        ipv4_address: 10.1.1.3
      occ_net:
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8105/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # TRANSMISSION SUBSTATIONS (SUB-001 to SUB-007)
  # ============================================================================

  node_sub001:
    build:
      context: .
      dockerfile: node_service/Dockerfile
    container_name: scada_node_sub001
    environment:
      NODE_ID: SUB-001
      NODE_TYPE: transmission
      UNIT_ID: 11
      REST_PORT: 8111
      WS_PORT: 8112
      MODBUS_PORT: 5030
      IEC104_PORT: 2411
      NODE_IP: 10.2.1.1
      DB_URL: postgresql://scada:scada123@timescaledb:5432/scadadb
      REDIS_URL: redis://redis:6379
      OCC_IP: 10.0.0.1
      SCADA_MASTER_URL: http://scada_master:9000
      LOG_LEVEL: info
    ports:
      - "8111:8111"
      - "8112:8112"
      - "5030:5030"
      - "2411:2411"
    networks:
      transmission_net:
        ipv4_address: 10.2.1.1
      occ_net:
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8111/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  node_sub002:
    build:
      context: .
      dockerfile: node_service/Dockerfile
    container_name: scada_node_sub002
    environment:
      NODE_ID: SUB-002
      NODE_TYPE: transmission
      UNIT_ID: 12
      REST_PORT: 8113
      WS_PORT: 8114
      MODBUS_PORT: 5031
      IEC104_PORT: 2412
      NODE_IP: 10.2.1.2
      DB_URL: postgresql://scada:scada123@timescaledb:5432/scadadb
      REDIS_URL: redis://redis:6379
      OCC_IP: 10.0.0.1
      SCADA_MASTER_URL: http://scada_master:9000
      LOG_LEVEL: info
    ports:
      - "8113:8113"
      - "8114:8114"
      - "5031:5031"
      - "2412:2412"
    networks:
      transmission_net:
        ipv4_address: 10.2.1.2
      occ_net:
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8113/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  node_sub003:
    build:
      context: .
      dockerfile: node_service/Dockerfile
    container_name: scada_node_sub003
    environment:
      NODE_ID: SUB-003
      NODE_TYPE: transmission
      UNIT_ID: 13
      REST_PORT: 8115
      WS_PORT: 8116
      MODBUS_PORT: 5032
      IEC104_PORT: 2413
      NODE_IP: 10.2.1.3
      DB_URL: postgresql://scada:scada123@timescaledb:5432/scadadb
      REDIS_URL: redis://redis:6379
      OCC_IP: 10.0.0.1
      SCADA_MASTER_URL: http://scada_master:9000
      LOG_LEVEL: info
    ports:
      - "8115:8115"
      - "8116:8116"
      - "5032:5032"
      - "2413:2413"
    networks:
      transmission_net:
        ipv4_address: 10.2.1.3
      occ_net:
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8115/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  node_sub004:
    build:
      context: .
      dockerfile: node_service/Dockerfile
    container_name: scada_node_sub004
    environment:
      NODE_ID: SUB-004
      NODE_TYPE: transmission
      UNIT_ID: 14
      REST_PORT: 8117
      WS_PORT: 8118
      MODBUS_PORT: 5033
      IEC104_PORT: 2414
      NODE_IP: 10.2.1.4
      DB_URL: postgresql://scada:scada123@timescaledb:5432/scadadb
      REDIS_URL: redis://redis:6379
      OCC_IP: 10.0.0.1
      SCADA_MASTER_URL: http://scada_master:9000
      LOG_LEVEL: info
    ports:
      - "8117:8117"
      - "8118:8118"
      - "5033:5033"
      - "2414:2414"
    networks:
      transmission_net:
        ipv4_address: 10.2.1.4
      occ_net:
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8117/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  node_sub005:
    build:
      context: .
      dockerfile: node_service/Dockerfile
    container_name: scada_node_sub005
    environment:
      NODE_ID: SUB-005
      NODE_TYPE: transmission
      UNIT_ID: 15
      REST_PORT: 8119
      WS_PORT: 8120
      MODBUS_PORT: 5034
      IEC104_PORT: 2415
      NODE_IP: 10.2.1.5
      DB_URL: postgresql://scada:scada123@timescaledb:5432/scadadb
      REDIS_URL: redis://redis:6379
      OCC_IP: 10.0.0.1
      SCADA_MASTER_URL: http://scada_master:9000
      LOG_LEVEL: info
    ports:
      - "8119:8119"
      - "8120:8120"
      - "5034:5034"
      - "2415:2415"
    networks:
      transmission_net:
        ipv4_address: 10.2.1.5
      occ_net:
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8119/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  node_sub006:
    build:
      context: .
      dockerfile: node_service/Dockerfile
    container_name: scada_node_sub006
    environment:
      NODE_ID: SUB-006
      NODE_TYPE: transmission
      UNIT_ID: 16
      REST_PORT: 8121
      WS_PORT: 8122
      MODBUS_PORT: 5035
      IEC104_PORT: 2416
      NODE_IP: 10.2.1.6
      DB_URL: postgresql://scada:scada123@timescaledb:5432/scadadb
      REDIS_URL: redis://redis:6379
      OCC_IP: 10.0.0.1
      SCADA_MASTER_URL: http://scada_master:9000
      LOG_LEVEL: info
    ports:
      - "8121:8121"
      - "8122:8122"
      - "5035:5035"
      - "2416:2416"
    networks:
      transmission_net:
        ipv4_address: 10.2.1.6
      occ_net:
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8121/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  node_sub007:
    build:
      context: .
      dockerfile: node_service/Dockerfile
    container_name: scada_node_sub007
    environment:
      NODE_ID: SUB-007
      NODE_TYPE: transmission
      UNIT_ID: 17
      REST_PORT: 8123
      WS_PORT: 8124
      MODBUS_PORT: 5036
      IEC104_PORT: 2417
      NODE_IP: 10.2.1.7
      DB_URL: postgresql://scada:scada123@timescaledb:5432/scadadb
      REDIS_URL: redis://redis:6379
      OCC_IP: 10.0.0.1
      SCADA_MASTER_URL: http://scada_master:9000
      LOG_LEVEL: info
    ports:
      - "8123:8123"
      - "8124:8124"
      - "5036:5036"
      - "2417:2417"
    networks:
      transmission_net:
        ipv4_address: 10.2.1.7
      occ_net:
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8123/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # DISTRIBUTION SUBSTATIONS (DIST-001 to DIST-005)
  # ============================================================================

  node_dist001:
    build:
      context: .
      dockerfile: node_service/Dockerfile
    container_name: scada_node_dist001
    environment:
      NODE_ID: DIST-001
      NODE_TYPE: distribution
      UNIT_ID: 21
      REST_PORT: 8131
      WS_PORT: 8132
      MODBUS_PORT: 5040
      IEC104_PORT: 2421
      NODE_IP: 10.3.1.1
      DB_URL: postgresql://scada:scada123@timescaledb:5432/scadadb
      REDIS_URL: redis://redis:6379
      OCC_IP: 10.0.0.1
      SCADA_MASTER_URL: http://scada_master:9000
      LOG_LEVEL: info
    ports:
      - "8131:8131"
      - "8132:8132"
      - "5040:5040"
      - "2421:2421"
    networks:
      distribution_net:
        ipv4_address: 10.3.1.1
      occ_net:
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8131/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  node_dist002:
    build:
      context: .
      dockerfile: node_service/Dockerfile
    container_name: scada_node_dist002
    environment:
      NODE_ID: DIST-002
      NODE_TYPE: distribution
      UNIT_ID: 22
      REST_PORT: 8133
      WS_PORT: 8134
      MODBUS_PORT: 5041
      IEC104_PORT: 2422
      NODE_IP: 10.3.1.2
      DB_URL: postgresql://scada:scada123@timescaledb:5432/scadadb
      REDIS_URL: redis://redis:6379
      OCC_IP: 10.0.0.1
      SCADA_MASTER_URL: http://scada_master:9000
      LOG_LEVEL: info
    ports:
      - "8133:8133"
      - "8134:8134"
      - "5041:5041"
      - "2422:2422"
    networks:
      distribution_net:
        ipv4_address: 10.3.1.2
      occ_net:
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8133/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  node_dist003:
    build:
      context: .
      dockerfile: node_service/Dockerfile
    container_name: scada_node_dist003
    environment:
      NODE_ID: DIST-003
      NODE_TYPE: distribution
      UNIT_ID: 23
      REST_PORT: 8135
      WS_PORT: 8136
      MODBUS_PORT: 5042
      IEC104_PORT: 2423
      NODE_IP: 10.3.1.3
      DB_URL: postgresql://scada:scada123@timescaledb:5432/scadadb
      REDIS_URL: redis://redis:6379
      OCC_IP: 10.0.0.1
      SCADA_MASTER_URL: http://scada_master:9000
      LOG_LEVEL: info
    ports:
      - "8135:8135"
      - "8136:8136"
      - "5042:5042"
      - "2423:2423"
    networks:
      distribution_net:
        ipv4_address: 10.3.1.3
      occ_net:
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8135/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  node_dist004:
    build:
      context: .
      dockerfile: node_service/Dockerfile
    container_name: scada_node_dist004
    environment:
      NODE_ID: DIST-004
      NODE_TYPE: distribution
      UNIT_ID: 24
      REST_PORT: 8137
      WS_PORT: 8138
      MODBUS_PORT: 5043
      IEC104_PORT: 2424
      NODE_IP: 10.3.1.4
      DB_URL: postgresql://scada:scada123@timescaledb:5432/scadadb
      REDIS_URL: redis://redis:6379
      OCC_IP: 10.0.0.1
      SCADA_MASTER_URL: http://scada_master:9000
      LOG_LEVEL: info
    ports:
      - "8137:8137"
      - "8138:8138"
      - "5043:5043"
      - "2424:2424"
    networks:
      distribution_net:
        ipv4_address: 10.3.1.4
      occ_net:
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8137/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  node_dist005:
    build:
      context: .
      dockerfile: node_service/Dockerfile
    container_name: scada_node_dist005
    environment:
      NODE_ID: DIST-005
      NODE_TYPE: distribution
      UNIT_ID: 25
      REST_PORT: 8139
      WS_PORT: 8140
      MODBUS_PORT: 5044
      IEC104_PORT: 2425
      NODE_IP: 10.3.1.5
      DB_URL: postgresql://scada:scada123@timescaledb:5432/scadadb
      REDIS_URL: redis://redis:6379
      OCC_IP: 10.0.0.1
      SCADA_MASTER_URL: http://scada_master:9000
      LOG_LEVEL: info
    ports:
      - "8139:8139"
      - "8140:8140"
      - "5044:5044"
      - "2425:2425"
    networks:
      distribution_net:
        ipv4_address: 10.3.1.5
      occ_net:
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8139/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # SCADA MASTER (Central API Gateway & Aggregator)
  # ============================================================================

  scada_master:
    build:
      context: ./scada_master
      dockerfile: Dockerfile_new
    container_name: scada_master_prod
    environment:
      REST_PORT: 9000
      WS_PORT: 9001
      JWT_SECRET: scada-jwt-change-in-production
      DB_URL: postgresql://scada:scada123@timescaledb:5432/scadadb
      REDIS_URL: redis://redis:6379
      LOG_LEVEL: INFO
      CORS_ORIGINS: "http://localhost:3000,http://localhost"
    ports:
      - "9000:9000"
      - "9001:9001"
    networks:
      generation_net:
      transmission_net:
      distribution_net:
      occ_net:
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
      node_gen001:
        condition: service_healthy
      node_gen002:
        condition: service_healthy
      node_gen003:
        condition: service_healthy
      node_sub001:
        condition: service_healthy
      node_sub002:
        condition: service_healthy
      node_sub003:
        condition: service_healthy
      node_sub004:
        condition: service_healthy
      node_sub005:
        condition: service_healthy
      node_sub006:
        condition: service_healthy
      node_sub007:
        condition: service_healthy
      node_dist001:
        condition: service_healthy
      node_dist002:
        condition: service_healthy
      node_dist003:
        condition: service_healthy
      node_dist004:
        condition: service_healthy
      node_dist005:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # ANOMALY DETECTION ENGINE
  # ============================================================================

  anomaly_engine:
    build:
      context: .
      dockerfile: anomaly_engine/Dockerfile
    container_name: scada_anomaly_engine
    environment:
      REST_PORT: 9500
      DB_URL: postgresql://scada:scada123@timescaledb:5432/scadadb
      REDIS_URL: redis://redis:6379
      SCADA_MASTER_URL: http://scada_master:9000
      LOG_LEVEL: info
    ports:
      - "9500:9500"
    networks:
      occ_net:
        ipv4_address: 10.0.0.105
    depends_on:
      scada_master:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9500/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # DASHBOARD (React + Vite + TypeScript)
  # ============================================================================

  dashboard:
    build:
      context: .
      dockerfile: dashboard/Dockerfile_new
    container_name: scada_dashboard
    ports:
      - "3000:80"
    networks:
      occ_net:
        ipv4_address: 10.0.0.110
    depends_on:
      scada_master:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 10s
      timeout: 5s
      retries: 3
    environment:
      - NGINX_HOST=0.0.0.0
      - NGINX_PORT=80

################################################################################
# VOLUMES
################################################################################

volumes:
  timescaledb_data:
  redis_data:
  prometheus_data:
  grafana_data:

################################################################################
# NETWORKS
################################################################################

networks:
  generation_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.1.0.0/16

  transmission_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.2.0.0/16

  distribution_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.3.0.0/16

  occ_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.0.0.0/16
